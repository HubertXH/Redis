### 主从数据同步
##### 1. 接受命令    
客户端给从服务器发送 SLAVEOF master_ip master_port 命令;从服务器将主服务器地址及端口号记录下来。
##### 2. 建立连接    
从服务器向主服务器发送链接请求，建立socket链接。链接建立成功后，从服务器会想起关联一个文件事件，负责处理后续的各种赋值操作。链接建立后从服务器相对于主服务器而言就是一个客户端，从服务器可以向主服务器发送命令，主服务器执行命令并且进行相应的返回。
##### 3. PING检测
从服务器向主服务器发送ping命令。
###### 作用：
- 检测连接是否正常工作
- 检测主服务器是否可以正常处理请求
###### 主服务器返回数据
- 主服务器正常返回数据，而从服务器无法正常读取命令，(timeout)说明连接无法正常工作，此种情况下，从服务器就会断开与主服务器的连接，重新开始建立连接。
- 主服务器返回ERROR数据，说明主服务器现在无法正常处理请求命令。同样从服务器会断开连接，再次重新建立连接。
- 主服务器返回PONG,从服务器顺利接收，连接工作正常，且主服务器可以正常的处理命令等请求。
##### 4. 权限认证    
主服务器可以配置requirepass从服务器配置masterauthor,主从服务器会根据相应的配置进行权限验证。
- 主服务器配置了requirepass，从服务器配置了masterauthor，那么从服务就会拿去相应的密码去主服务器上做权限验证，若密码匹配成功就开始后续复制工作，若匹配失败则返回invalidpassword错误。
- 主服务器配置了requirepass，从服务器没有配置masterauthor，那么从服务器会直接去请求主服务器，主服务器拒绝并返回NOAUTH的错误。
- 主服务器没有配置requirepass，从服务器配置了masterauth，则主服务器返回no password is set 的错误。    
上述的所有错误都会让从服务器断开连接，重新从建立连接开始，直到验证通过或者从服务器放弃同步数据。
##### 5. 从服务器上报信息
从服务器向主服务器发送REPLCONF listening-port <port-number>命令向主服务器上报自己监听的端口号。主服务器收到该命令后会将端口号存在对应的客户端的信息中。在主服务器上可以使用 INFO relpication 命令查看相应的从服务器信息。     
  
##### 6. 同步数据 
从服务器向主服务器发送同步命令 PSYNC <run_id> offset;
- 若从服务器第一次向主服务器同步数据则发送 PSYNC ？ -1 给主服务器，主服务器返回+FULLRESYNC <run_id(主服务器ID)>  offset(同步数据的offset)给从服务器，从服务器记录下 run_id，和offset。
- 若从服务器非启动一次向主服务器同步数，则主服务器返回+COUNTINUE表示主服务器将与从服务器进行部分重同步操作。
首先主服务器会根据从服务器传送过来的run_id与自身的Id进行对比，若一样就进行部分重新同步，若不一样就进行完全重新同步。
1. 完全同步的过程中，主服务器会先执行BGSAVE生成RDB文件，在生成RDB文件期间的写请求会记录进缓冲区，将RDB传送给从服务器后，主服务器会像从服务器发送缓冲去的写命令进行同步，已达到主从服务器完全同步。    
2. 在部分重新同步的过程中，主服务器会根据从服务传送过来的offset在复制积压缓冲区查找offset后面的命令是否还在队列中，若在队列中则就会像从服务器发送之后的写命令给从服务器，若队列中以没有该offset之后的数据则会进行全量同步。
##### 心跳检测
从服务器默认在每一秒会向主服务器发送命令 REPLCONF ACK <replication_offset>
 - 检测服务器的连接网络状态。若主服务器超过一秒没有收到从服务器发送而来的命令则就会认为与从服务器之间的连接出现了问题。
 - 辅助实现min-slaves，根据参数 min-slaves-to-write x，min-slaves-max-log x 最小从服务器数量，最大服务器的延迟若超过该数值则主服务器会拒绝执行写命令。
- 检测命令的丢失。根据该命令所携带的replication_offset来检测是否有一些写命令没有传送值从服务器，若有，则进行数据的补发。
